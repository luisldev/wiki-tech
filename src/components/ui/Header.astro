---
const normalize = (path: string) => path.replace(/\/+$/, '') || '/';
const currentPath = normalize(Astro.url.pathname);

const navLinks = [
  { href: '/', text: 'Inicio' },
  { href: '/pc-builder', text: 'Ensambles' },
  { href: '/printers', text: 'Impresoras' },
  { href: '/guides', text: 'Guías' },
];
---

<header
  id='mainHeader'
  class='font-primary bg-neutral-100 dark:bg-neutral-900 max-w-340 w-11/12 lg:w-full z-50 shadow-sm rounded-lg fixed left-1/2 transform -translate-x-1/2 py-1'
>
  <nav class='flex items-center justify-between px-2.5 py-1.5'>
    <a
      class='flex-none pl-1 font-semibold text-lg text-neutral-600 dark:text-neutral-400 hover:opacity-80'
      href='/'
      aria-label='Wiki-Tech página principal'
    >
      Wiki-Tech
    </a>

    <button
      type='button'
      id='menuToggle'
      aria-label='Abrir menú'
      aria-controls='mobileMenu'
      class='sm:hidden inline-flex items-center justify-center size-8 rounded-lg focus:outline-none hover:text-neutral-200 transition-transform duration-200'
    >
      <svg
        id='iconMenu'
        class='size-6 block'
        xmlns='http://www.w3.org/2000/svg'
        fill='none'
        viewBox='0 0 24 24'
        stroke-width='1.5'
        stroke='currentColor'
      >
        <path
          stroke-linecap='round'
          stroke-linejoin='round'
          d='M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5'></path>
      </svg>
      <svg
        id='iconClose'
        class='size-6 hidden'
        xmlns='http://www.w3.org/2000/svg'
        fill='none'
        viewBox='0 0 24 24'
        stroke-width='1.5'
        stroke='currentColor'
      >
        <path
          stroke-linecap='round'
          stroke-linejoin='round'
          d='M6 18L18 6M6 6l12 12'></path>
      </svg>
    </button>

    <div
      id='mobileMenu'
      aria-expanded='false'
      class='w-full rounded-lg shadow-sm sm:shadow-none hidden
      transition-all duration-300 ease-in-out basis-full grow
      sm:block sm:basis-auto absolute sm:relative top-full left-0 dark:bg-neutral-900 p-4 sm:p-0
      opacity-0 translate-y-2.5 sm:opacity-100 sm:translate-y-0'
    >
      <div
        class='flex flex-col gap-y-2 sm:flex-row sm:items-center sm:justify-end sm:gap-y-0 sm:mt-0'
      >
        {
          navLinks.map((link) => {
            const isActive = normalize(link.href) === currentPath;
            return (
              <a
                href={link.href}
                class:list={[
                  'font-medium py-1.5 px-3 rounded-md transition duration-150 focus:outline-none',
                  {
                    'bg-neutral-300 dark:bg-neutral-950 text-neutral-950 dark:text-neutral-100':
                      isActive,
                    'hover:opacity-80 text-neutral-400': !isActive,
                  },
                ]}
                aria-current={isActive ? 'page' : false}
              >
                {link.text}
              </a>
            );
          })
        }
      </div>
    </div>
  </nav>
</header>

<script is:inline>
  function initMenu() {
    const toggleButton = document.getElementById('menuToggle');
    const mobileMenu = document.getElementById('mobileMenu');
    const iconMenu = document.getElementById('iconMenu');
    const iconClose = document.getElementById('iconClose');
    if (!toggleButton || !mobileMenu) return;

    // Evita duplicar eventos
    toggleButton.replaceWith(toggleButton.cloneNode(true));
    const newToggleButton = document.getElementById('menuToggle');

    newToggleButton.addEventListener('click', () => {
      const isOpen = mobileMenu.classList.contains('hidden');

      if (isOpen) {
        mobileMenu.classList.remove('hidden');
        requestAnimationFrame(() => {
          mobileMenu.classList.remove('opacity-0', 'translate-y-2.5');
        });
      } else {
        mobileMenu.classList.add('opacity-0', 'translate-y-2.5');
        mobileMenu.addEventListener(
          'transitionend',
          () => mobileMenu.classList.add('hidden'),
          { once: true },
        );
      }

      newToggleButton.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
      iconMenu.classList.toggle('hidden');
      iconClose.classList.toggle('hidden');
    });

    // Cierra el menú al hacer clic en un enlace
    mobileMenu.querySelectorAll('a').forEach((link) => {
      link.addEventListener('click', () => {
        if (window.innerWidth < 640) {
          mobileMenu.classList.add('opacity-0', 'translate-y-2.5');
          mobileMenu.addEventListener(
            'transitionend',
            () => mobileMenu.classList.add('hidden'),
            { once: true },
          );
          iconMenu.classList.remove('hidden');
          iconClose.classList.add('hidden');
        }
      });
    });
  }

  initMenu();
  document.addEventListener('astro:after-swap', initMenu);
</script>
